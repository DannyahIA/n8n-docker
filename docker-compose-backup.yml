version: '3.8'

services:
  n8n:
    image: 'n8nio/n8n:latest'
    container_name: n8n_backup
    restart: unless-stopped
    ports:
      - '5679:5678'  
    volumes:
      - ./backup_data/n8n_data:/home/node/.n8n
      - ./backup_data/files:/files
    environment:
      - N8N_HOST=${N8N_HOST}
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - NODE_ENV=production 
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD}
      - WEBHOOK_URL=${WEBHOOK_URL}
      - N8N_SECURE_COOKIE=${N8N_SECURE_COOKIE}
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=${N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS}
      - DB_SQLITE_POOL_SIZE=${DB_SQLITE_POOL_SIZE}
      - N8N_RUNNERS_ENABLED=${N8N_RUNNERS_ENABLED}
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=${N8N_BLOCK_ENV_ACCESS_IN_NODE}
      - N8N_GIT_NODE_DISABLE_BARE_REPOS=${N8N_GIT_NODE_DISABLE_BARE_REPOS}
      - TZ=America/Sao_Paulo
      - N8N_LOG_LEVEL=info
      - N8N_METRICS=true
    networks:
      - backup_network
    depends_on:
      - postgres

  evolution-api:
    image: 'evoapicloud/evolution-api:latest'
    container_name: evolution_api_backup
    restart: unless-stopped
    ports:
      - '8081:8080'  
    volumes:
      - evolution_instances_backup:/evolution/instances
    environment:
      - SERVER_NAME=${EVOLUTION_SERVER_NAME}
      - SERVER_TYPE=http
      - SERVER_PORT=8080
      - SERVER_URL=${EVOLUTION_SERVER_URL}
      - CORS_ORIGIN=${EVOLUTION_CORS_ORIGIN}
      - CORS_METHODS=GET,POST,PUT,DELETE
      - CORS_CREDENTIALS=true
      - LOG_LEVEL=${EVOLUTION_LOG_LEVEL}
      - LOG_COLOR=true
      - LOG_BAILEYS=error
      - DEL_INSTANCE=false
      - DATABASE_PROVIDER=postgresql
      - DATABASE_CONNECTION_URI=postgresql://${POSTGRES_USERNAME}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DATABASE}?schema=public
      - DATABASE_CONNECTION_CLIENT_NAME=evolution_backup
      - DATABASE_SAVE_DATA_INSTANCE=true
      - DATABASE_SAVE_DATA_NEW_MESSAGE=true
      - DATABASE_SAVE_MESSAGE_UPDATE=true
      - DATABASE_SAVE_DATA_CONTACTS=true
      - DATABASE_SAVE_DATA_CHATS=true
      - DATABASE_SAVE_DATA_LABELS=true
      - DATABASE_SAVE_DATA_HISTORIC=true
      - WEBHOOK_GLOBAL_ENABLED=${EVOLUTION_WEBHOOK_GLOBAL_ENABLED}
      - WEBHOOK_GLOBAL_URL=${EVOLUTION_WEBHOOK_GLOBAL_URL}
      - WEBHOOK_EVENTS_QRCODE_UPDATED=true
      - WEBHOOK_EVENTS_MESSAGES_UPSERT=true
      - WEBHOOK_EVENTS_CONNECTION_UPDATE=true
      - CONFIG_SESSION_PHONE_CLIENT=Evolution API Backup
      - QRCODE_LIMIT=30
      - AUTHENTICATION_API_KEY=${EVOLUTION_API_KEY}
      - AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES=true
      - CACHE_REDIS_ENABLED=true
      - CACHE_REDIS_URI=redis://redis:6379/6
      - CACHE_REDIS_PREFIX_KEY=evolution_backup
      - TYPEBOT_ENABLED=${TYPEBOT_ENABLED}
      - TYPEBOT_API_VERSION=latest
      - TZ=America/Sao_Paulo
    networks:
      - backup_network
    depends_on:
      - postgres
      - redis

  redis:
    image: 'redis:latest'
    container_name: redis_backup
    restart: unless-stopped
    command: redis-server --appendonly yes --port 6379
    volumes:
      - redis_data_backup:/data
    networks:
      - backup_network
    expose:
      - "6379"

  postgres:
    image: 'postgres:15'
    container_name: postgres_backup
    restart: unless-stopped
    environment:
      - POSTGRES_DB=${POSTGRES_DATABASE}
      - POSTGRES_USER=${POSTGRES_USERNAME}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    command:
      - postgres
      - -c
      - max_connections=1000
      - -c
      - listen_addresses=*
    volumes:
      - postgres_data_backup:/var/lib/postgresql/data
    networks:
      - backup_network
    expose:
      - "5432"

  typebot-builder:
    image: 'baptistearno/typebot-builder:latest'
    container_name: typebot_builder_backup
    restart: unless-stopped
    ports:
      - '3001:3000'  
    environment:
      - NEXTAUTH_URL=${TYPEBOT_NEXTAUTH_URL}
      - NEXTAUTH_URL_INTERNAL=http://typebot-builder:3000
      - NEXT_PUBLIC_VIEWER_URL=${TYPEBOT_VIEWER_URL}
      - ENCRYPTION_SECRET=${TYPEBOT_ENCRYPTION_SECRET}
      - DATABASE_URL=postgresql://${POSTGRES_USERNAME}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DATABASE}?schema=typebot
      - NEXTAUTH_SECRET=${TYPEBOT_NEXTAUTH_SECRET}
      - S3_ACCESS_KEY=${TYPEBOT_S3_ACCESS_KEY}
      - S3_SECRET_KEY=${TYPEBOT_S3_SECRET_KEY}
      - S3_BUCKET=${TYPEBOT_S3_BUCKET}
      - S3_ENDPOINT=${TYPEBOT_S3_ENDPOINT}
      - DISABLE_SIGNUP=${TYPEBOT_DISABLE_SIGNUP}
      - TZ=America/Sao_Paulo
    networks:
      - backup_network
    depends_on:
      - postgres

  typebot-viewer:
    image: 'baptistearno/typebot-viewer:latest'
    container_name: typebot_viewer_backup
    restart: unless-stopped
    ports:
      - '3002:3000' 
    environment:
      - NEXTAUTH_URL=${TYPEBOT_NEXTAUTH_URL}
      - NEXT_PUBLIC_VIEWER_URL=${TYPEBOT_VIEWER_URL}
      - ENCRYPTION_SECRET=${TYPEBOT_ENCRYPTION_SECRET}
      - DATABASE_URL=postgresql://${POSTGRES_USERNAME}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DATABASE}?schema=typebot
      - S3_ACCESS_KEY=${TYPEBOT_S3_ACCESS_KEY}
      - S3_SECRET_KEY=${TYPEBOT_S3_SECRET_KEY}
      - S3_BUCKET=${TYPEBOT_S3_BUCKET}
      - S3_ENDPOINT=${TYPEBOT_S3_ENDPOINT}
      - TZ=America/Sao_Paulo
    networks:
      - backup_network
    depends_on:
      - postgres

  nginx-proxy-manager:
    image: 'jc21/nginx-proxy-manager:latest'
    container_name: nginx_proxy_backup
    restart: unless-stopped
    ports:
      - '8080:80'  
      - '8181:81'    
      - '4443:443'   
    volumes:
      - ./backup_data/nginx_data:/data
      - ./backup_data/nginx_letsencrypt:/etc/letsencrypt
    networks:
      - backup_network

volumes:
  evolution_instances_backup:
    driver: local
  redis_data_backup:
    driver: local
  postgres_data_backup:
    driver: local

networks:
  backup_network:
    name: backup_network
    driver: bridge